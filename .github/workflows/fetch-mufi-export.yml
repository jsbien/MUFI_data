# .github/workflows/fetch-mufi-export.yml

name: Fetch MUFI Export Data

permissions:
	contents: write

on: schedule: - cron: '0 4 * * *' # Daily at 04:00 UTC â€” adjust later for weekly workflow_dispatch:

jobs: fetch: runs-on: ubuntu-latest

steps:
  - name: Checkout repo
    uses: actions/checkout@v3

  - name: Set up folders
    run: |
      mkdir -p data/json
      mkdir -p data/csv

  - name: Download JSON
    run: |
      curl -sSL 'https://gefin.ku.dk/q.php?q=mufiexport&f=json' -o data/json/mufiexport.json

  - name: Download CSV
    run: |
      curl -sSL 'https://gefin.ku.dk/q.php?q=mufiexport&f=csv' -o data/csv/mufiexport.csv

  - name: Check for changes and commit
    id: commit
    run: |
      git config user.name "jsbien"
      git config user.email "jsbien@mimuw.edu.pl"
      git add data/
      if git diff --cached --quiet; then
        echo "No changes detected"
        echo "changes_detected=false" >> "$GITHUB_OUTPUT"
      else
        git commit -m "Update MUFI export on $(date -u)"
        # Use the built-in GITHUB_TOKEN (requires permissions: contents: write above)
        git remote set-url origin https://x-access-token:${{ secrets.MUFI_ACCESS }}@github.com/${{ github.repository }}.git
        git push origin main
        echo "changes_detected=true" >> "$GITHUB_OUTPUT"
      fi

  - name: Send commit notification email
    if: steps.commit.outputs.changes_detected == 'true'
    uses: dawidd6/action-send-mail@v3
    with:
      server_address: ${{ secrets.SMTP_SERVER }}
      server_port: ${{ secrets.SMTP_PORT }}
      username: ${{ secrets.SMTP_USERNAME }}
      password: ${{ secrets.SMTP_PASSWORD }}
      subject: "MUFI export updated on $(date -u)"
      to: ${{ secrets.EMAIL_TO }}
      from: ${{ secrets.SMTP_USERNAME }}
      body: |
        A new MUFI export has been committed to jsbien/MUFI_data.

        Commit message:
        Update MUFI export on $(date -u)

        View repository:
        https://github.com/jsbien/MUFI_data
